---
- name: Configure networking server VM
  hosts: networking_server
  vars:
    swap_size: 2G
    swappiness: 1
    vfs_cache_pressure: 50
    packages:
      - sudo
      - ncdu
      - curl
      - git
      - htop
      - gnupg
      - podman
      - qemu-guest-agent # needed for graceful shutdowns and to get the IP address of the VM from the host
      - resolvconf # needed for `dns-nameservers` to work in `/etc/network/interfaces`
      - avahi-daemon # needed for mDNS (.local) hostname resolution (server)
      - libnss-mdns # needed for mDNS (.local) hostname resolution (client)
      - openssl # needed for generating self-signed certificates
    user_groups:
      - name: d3strukt0r
        groups:
          - sudo
    git_user_name: D3strukt0r
    git_user_email: dev@d3strukt0r.dev
    git_user_signingkey: C9E5AB85364CA764!
    gpg_key_src: ./private.gpg # only needed once to import the key, can be removed after that
    ssh_key_src: ./id_ed25519 # only needed once to deploy the key, can be removed after that
    network_interface: ens18
    network_ip: 192.168.1.13/24
    network_gateway: 192.168.1.1
    network_dns: 192.168.1.1
    mdns_hostname: network-docker
    container_data_dir: ~/container-data
    tier1_dir: "{{ playbook_dir }}/../../server-container/network-docker/tier1"
    materia_age_private_key: "" # set via --extra-vars or Ansible vault
    vault_agent_token: "" # set via --extra-vars after Vault initialization
    backbone_interface: "{{ network_interface }}" # Used by sysctl_thread.yml for IPv6 router advertisements
  tasks:
    # --- Base system setup ---
    - name: Remove CD-ROM apt source
      ansible.builtin.include_tasks: ../common/tasks/apt_cdrom_cleanup.yml
    - name: Install packages
      ansible.builtin.include_tasks: ../common/tasks/packages.yml
    - name: Configure network
      ansible.builtin.include_tasks: ../common/tasks/network.yml
    - name: Configure mDNS
      ansible.builtin.include_tasks: ../common/tasks/mdns.yml
    - name: Configure user groups
      ansible.builtin.include_tasks: ../common/tasks/user_groups.yml
    - name: Configure swap
      ansible.builtin.include_tasks: ../common/tasks/swap.yml
    - name: Configure swappiness
      ansible.builtin.include_tasks: ../common/tasks/swappiness.yml
    - name: Configure vfs_cache_pressure
      ansible.builtin.include_tasks: ../common/tasks/vfs_cache_pressure.yml
    - name: Configure daily apt upgrade
      ansible.builtin.include_tasks: ../common/tasks/apt_daily_upgrade.yml
    - name: Harden SSH
      ansible.builtin.include_tasks: ../common/tasks/sshd.yml
    - name: Configure podman
      ansible.builtin.include_tasks: ../common/tasks/podman.yml
    - name: Configure sysctl
      ansible.builtin.include_tasks: ../common/tasks/sysctl.yml
    - name: Configure qemu-guest-agent
      ansible.builtin.include_tasks: ../common/tasks/qemu_guest_agent.yml
    - name: Install wrapper scripts
      ansible.builtin.include_tasks: ../common/tasks/scripts.yml
    - name: Deploy SSH key
      ansible.builtin.include_tasks: ../common/tasks/ssh_key.yml
    - name: Import GPG key
      ansible.builtin.include_tasks: ../common/tasks/gpg_import.yml
    - name: Configure git
      ansible.builtin.include_tasks: ../common/tasks/git_config.yml
    # --- Tier 1: Bootstrap infrastructure ---
    - name: Deploy proxy network
      ansible.builtin.include_tasks: ../common/tasks/quadlet_network.yml
    - name: Prepare certificate directories
      ansible.builtin.include_tasks: ../common/tasks/certs.yml
    - name: Deploy Vault
      ansible.builtin.include_tasks: ../common/tasks/vault.yml
    - name: Deploy Vault Agent
      ansible.builtin.include_tasks: ../common/tasks/vault_agent.yml
    # --- System prerequisites for Tier 2 HA stack (rootless, Materia-managed) ---
    - name: Configure sysctl for Thread
      ansible.builtin.include_tasks: ../common/tasks/sysctl_thread.yml
    - name: Load kernel modules for Thread
      ansible.builtin.include_tasks: ../common/tasks/kernel_modules.yml

    # --- Tier 2: Materia-managed services ---
    - name: Deploy Materia
      ansible.builtin.include_tasks: ../common/tasks/materia.yml
  handlers:
    - name: Restart sshd
      become: true
      ansible.builtin.service:
        name: sshd
        state: restarted
    - name: Restart networking
      become: true
      ansible.builtin.service:
        name: networking
        state: restarted
    - name: Reload systemd user daemon
      ansible.builtin.systemd:
        daemon_reload: true
        scope: user
