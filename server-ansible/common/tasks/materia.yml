---
- name: Create Materia data directory
  ansible.builtin.file:
    path: "~/.local/share/materia"
    state: directory
    mode: "0700"

- name: Deploy age private key for Materia
  ansible.builtin.copy:
    content: "{{ materia_age_private_key }}"
    dest: "~/.local/share/materia/age-key.txt"
    mode: "0600"

- name: Deploy Materia Quadlet
  ansible.builtin.copy:
    src: "{{ tier1_dir }}/materia/materia.container"
    dest: "~/.config/containers/systemd/materia.container"
    mode: "0644"
  notify: Reload systemd user daemon

- name: Deploy Materia update timer
  ansible.builtin.copy:
    src: "{{ tier1_dir }}/materia/materia-update.timer"
    dest: "~/.config/containers/systemd/materia-update.timer"
    mode: "0644"
  notify: Reload systemd user daemon

- name: Flush handlers to reload systemd
  ansible.builtin.meta: flush_handlers

- name: Enable Materia update timer
  ansible.builtin.systemd:
    name: materia-update.timer
    enabled: true
    state: started
    scope: user

- name: Run initial Materia update
  ansible.builtin.systemd:
    name: materia
    state: started
    scope: user
